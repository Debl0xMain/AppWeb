<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body class="px-3">

{% for histo_cmd in histo_cmd %}
<pre>
    {{ dump(histo_cmd) }}
</pre>
{# Entete #}
<article class="row">
    <div class="mx-auto text-center">
        <h2 class="text-center">Facture numéro {{ histo_cmd.ordRebBill }}</h2>
    </div>
</article>

<hr>
    {% for product_orders in product_orders %}
    {% if product_orders.orders.id == histo_cmd.id %}
<pre>
    {{ dump(product_orders) }}
</pre>
<pre>
    {{ dump(histo_cmd) }}
</pre>
<pre>
    {{ dump(user) }}
</pre>
{% endif %}
{% endfor %}
{# Info Client #}

<article class="row">
    <section class="col text-center mx-3 border my-auto">
        <h5 class="my-2 text-bold">Client Info</h5>
        <p>{{ user[0].userName }} {{ user[0].userFristName }}</p>
        <p>Ref Client : {{ user[0].userRef }}</p>
    </section>
    
    {% if user[0].userCompanySiret != null %}
    <section class="col text-center mx-3 border my-auto">
        <div class="row">
            <h5 class="my-2">Company Info</h5>
            <p>Company : {{ user[0].userCompanyName }}</p>
            <p>Siret : {{ user[0].userCompanySiret }}</p>
        </div>
    </section>
    {% endif %}
</article>
<hr>
{# Information Command #}
<article class="border px-auto py-2">
 <div class='row text-center'>
            <div class="col my-auto mx-5">
                <p class="row">ref</p>
                <p class="row">{{ histo_cmd.ordref }}</p>
            </div>
            <div class="col my-auto mx-5">
                <p class="row">Status</p>
                    {% if histo_cmd.ordStatusBill  == 1 %}
                    <p class="row">Attente</p>
                    {% endif %}
                    {% if histo_cmd.ordStatusBill  == 2 %}
                    <p class="row">Payé</p>
                    {% endif %}
                    {% if histo_cmd.ordStatusBill  == 3 %}
                    <p class="row">Retard</p>
                    {% endif %}
            </div>
            <div class="col my-auto mx-5">
                <p class="row">Date</p>
                <p class="row">{{ histo_cmd.ordDateBill|date("m/d/Y") }}</p>
            </div>
            <div class="col my-auto mx-5">
                <p class="row">Prix</p>
                <p class="row">{{ histo_cmd.ordPrixTotal}}€</p>
            </div>
            <div class="col my-auto mx-5">
                <p>Livraison : <br> {{ histo_cmd.ordAdressDelivery }}</p>
                <p>Facturation : <br> {{ histo_cmd.ordAdressBilling }}</p>
            </div>
</article>
{# Produits #}
<hr>
    {% for product_orders in product_orders %}
        {% if product_orders.orders.id == histo_cmd.id %}
<article class="border row py-2">
        <div class="col">
            <p class="row">Nom :</p>
            <p class="row">{{ product_orders.ProOrdNameProduct }}</p>
        </div>
        {# set variable #}
        {# Prix * Coef prix base article #}
        {% set prix_u_article = (product_orders.ProOrdPriceUht * histo_cmd.ordClientCoefficient)|round(2, 'floor') %}
         {# Total HT #}
        {% set total_ht = ( prix_u_article * product_orders.ProOrdProductQuantity)|round(2, 'floor') %}
        {# Calcul TVA #}
        {% set tva_produit = (prix_u_article * 0.20)|round(2,'floor') %}
        {# Total TTC #}
        {% set total_ttc = (total_ht * 1.20)|round(2,'floor') %}

        <div class="col">
            <p>Prix u/ht</p>
            <p>{{ prix_u_article }}</p>
        </div>
        <div class="col">
            <p>Tva</p>
            <p>{{ tva_produit }}</p>
        </div>
        <div class="col">
            <p class="row">Quantité :</p>
            <p class="row">{{ product_orders.ProOrdProductQuantity }}</p>
        </div>
        {#  #}
        <div class="col">
            <p>Prix Total HT</p>
            <p>{{ total_ht }}</p>
        </div>
        <div class="col">
            <p>Prix Total TTC</p>
            <p>{{ total_ttc }}</p>
        </div>
</article>
        {% endif %}
    {% endfor %}

<hr>

{# produit #}
<div class="row">
    {% for product_orders in product_orders %}
        {% if product_orders.orders.id == histo_cmd.id %}

            <div class="col">
                {% if 'ROLE_PRO' in user[0].Roles[0] %}
                    {% set resultat_prix_u = ((((product_orders.ProOrdPriceUht)* histo_cmd.ordClientCoefficient ))* product_orders.ProOrdProductQuantity)|round(2, 'floor') %}
                    <p class="row">Prix/u :</p>
                    <p class="row">{{ resultat_prix_u }}€</p>
                {% endif %}
                {% if 'ROLE_USER' in user[0].Roles[0] %}
                    {% set resultat_prix_u = ((((product_orders.ProOrdPriceUht)* histo_cmd.ordClientCoefficient )*1.20)* product_orders.ProOrdProductQuantity)|round(2, 'floor') %}
                    <p class="row">Prix/u :</p>
                    <p class="row">{{ resultat_prix_u }}€</p>
                {% endif %}
            </div>
            <div class="col">
                {% if 'ROLE_PRO' in user[0].Roles[0] %}
                    {% set resultat_prix_u = ((((product_orders.ProOrdPriceUht)* histo_cmd.ordClientCoefficient ))* product_orders.ProOrdProductQuantity)|round(2, 'floor') %}
                    <p class="row">Prix/Quantité :</p>
                    <p class="row">{{ resultat_prix_u }}€</p>   
                {% endif %}
                {% if 'ROLE_USER' in user[0].Roles[0] %}
                    {% set resultat_prix_u = ((((product_orders.ProOrdPriceUht)* histo_cmd.ordClientCoefficient )*1.20)* product_orders.ProOrdProductQuantity)|round(2, 'floor') %}
                    <p class="row">Prix/Quantité :</p>
                    <p class="row">{{ resultat_prix_u }}€</p>
                {% endif %}
            </div>
        {# product_delivery #}
        {% for histo_delivery in histo_delivery %}
        {% for product_delivery in product_delivery %}
                {% if (histo_delivery.orders.id == histo_cmd.id) and (histo_delivery.id == product_delivery.delivery.id) %}
                    <div class="col mx-2">
                        <p class="row">Expedition </p>
                        <p class="row">{{ histo_delivery.delDateExped|date("m/d/Y") }}</p>
                    </div>
                    <div class="col mx-2">
                            {# Planified Date Not Hidden #}
                                {% if histo_delivery.delDateDeliveryClient == null %}
                        <p class="row">En cours</p>
                        <p class="row">{{ histo_delivery.delDatePlannedDelivery|date("m/d/Y") }}</p>
                                {% endif %}
                            {# Delivery Date #}
                                {% if histo_delivery.delDateDeliveryClient != null %}
                        <p class="row">Livré</p>
                        <p class="row">{{ histo_delivery.delDateDeliveryClient|date("m/d/Y") }}</p>
                {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
            {% endfor %}
        {% endif %}
    {% endfor %}
</div>
{% endfor %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>